<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>时间轴记录</title>
  <style>
    :root{
      --bg: #0b1020;
      --panel: rgba(255,255,255,0.06);
      --panel-strong: rgba(255,255,255,0.12);
      --text: #e8ecf8;
      --muted: #a7b0c0;
      --primary: #7aa2ff;
      --accent: #86f7d3;
      --danger: #ff7a99;
      --shadow: 0 20px 50px rgba(0,0,0,0.35);
      --radius-xl: 18px;
      --radius-lg: 14px;
      --radius-md: 10px;
      --line: linear-gradient(180deg, #7aa2ff, #86f7d3);
      --gutter: clamp(56px, 8vw, 80px); /* 竖线与卡片的基准间距 */
      --font-base: clamp(14px, 1.1vw + 10px, 16px);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    html{font-size:var(--font-base);}
    body{
      margin:0; font-family: ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";
      background: var(--bg);
      color: var(--text);
      font-size:1rem;
      position:relative;
      min-height:100%;
    }
    body::before{
      content:"";
      position:fixed;
      inset:0;
      pointer-events:none;
      background: radial-gradient(1200px 700px at 20% -10%, rgba(134,247,211,0.18), transparent 60%),
                  radial-gradient(900px 700px at 120% 10%, rgba(122,162,255,0.15), transparent 45%);
      mask-image: linear-gradient(180deg, rgba(0,0,0,1) 0%, rgba(0,0,0,0) 96%);
      -webkit-mask-image: linear-gradient(180deg, rgba(0,0,0,1) 0%, rgba(0,0,0,0) 96%);
      z-index:-1;
    }
    body.modal-open{overflow:hidden}
    .app{display:grid; grid-template-columns: 1fr; gap:20px; padding:clamp(16px, 4vw, 24px); max-width:1400px; margin:0 auto}
    header{
      grid-column: 1 / -1;
      position: sticky; top:0; z-index:10; backdrop-filter: blur(10px);
      background: linear-gradient(180deg, rgba(11,16,32,0.8), rgba(11,16,32,0.5));
      border-bottom: 1px solid var(--panel-strong);
      margin:calc(-1 * clamp(16px, 4vw, 24px)) calc(-1 * clamp(16px, 4vw, 24px)) 16px;
      padding:16px clamp(16px, 4vw, 24px) 18px;
    }
    .titlebar{display:flex; align-items:center; justify-content:space-between; gap:16px; flex-wrap:wrap; margin-bottom:14px}
    h1{margin:0; font-size:clamp(20px, 4vw, 28px); letter-spacing:0.5px}
    .actions{display:flex; gap:10px; flex-wrap:wrap}
    button{
      -webkit-tap-highlight-color: transparent;
    }
    .btn{
      position:relative; appearance:none; border:1px solid transparent; color:var(--text);
      background: linear-gradient(135deg, rgba(122,162,255,0.18), rgba(134,247,211,0.08));
      padding:10px 16px; border-radius:999px; cursor:pointer;
      transition: .2s transform,.2s box-shadow,.2s background;
      box-shadow: inset 0 0 0 1px rgba(134,247,211,0.15), 0 8px 18px rgba(11,16,32,0.45);
      font-weight:500; letter-spacing:0.2px;
    }
    .btn::after{
      content:""; position:absolute; inset:0; border-radius:999px;
      background: linear-gradient(135deg, rgba(255,255,255,0.08), rgba(255,255,255,0));
      opacity:0; transition: .2s opacity;
    }
    .btn:hover{transform: translateY(-2px); box-shadow: inset 0 0 0 1px rgba(134,247,211,0.35), 0 16px 30px rgba(9,14,29,0.45)}
    .btn:hover::after{opacity:1}
    .btn.danger{
      background: linear-gradient(135deg, rgba(255,122,153,0.25), rgba(255,179,122,0.15));
      box-shadow: inset 0 0 0 1px rgba(255,122,153,0.35), 0 8px 18px rgba(34,8,20,0.65);
    }
    .btn.danger:hover{box-shadow: inset 0 0 0 1px rgba(255,179,122,0.5), 0 18px 34px rgba(34,8,20,0.6)}
    .btn.primary{
      background: linear-gradient(135deg, #6b8cff, #6fe6c9);
      border: none;
      color:#041232;
      box-shadow: 0 18px 34px rgba(30,48,102,0.55);
    }
    .btn.primary::after{display:none}
    .btn.primary:hover{transform: translateY(-3px); box-shadow:0 22px 40px rgba(30,48,102,0.6)}

    .card{background: var(--panel); border:1px solid var(--panel-strong); border-radius: var(--radius-xl); box-shadow: var(--shadow)}

    .modal{position:fixed; inset:0; display:none; align-items:center; justify-content:center; backdrop-filter: blur(4px); background: rgba(4,8,20,0.58); z-index:1000; padding:24px}
    .modal.active{display:flex}
    .modal-panel{width:min(920px, 94vw); padding:18px 20px; border-radius: var(--radius-xl); position:relative; overflow:hidden}
    .modal-panel::before{content:""; position:absolute; inset:-40% 10% auto; height:60%; background: radial-gradient(60% 80% at 50% 0%, rgba(134,247,211,0.18), transparent); opacity:0.8; pointer-events:none}
    .modal-panel--sm{width:min(420px, 92vw); padding:22px 24px}
    .modal-head{display:flex; align-items:center; justify-content:space-between; gap:16px; margin-bottom:14px}
    .modal-title{font-size:18px; font-weight:600; letter-spacing:0.3px}
    .modal-body{font-size:14px; color:var(--muted); line-height:1.6}
    .modal-body strong{color:var(--text)}
    .modal-actions{display:flex; justify-content:flex-end; gap:12px; margin-top:22px}
    .modal-icon{width:46px; height:46px; border-radius:50%; display:grid; place-items:center; background: rgba(122,162,255,0.16); border:1px solid rgba(122,162,255,0.35); color:#c9d9ff; box-shadow: inset 0 0 0 1px rgba(122,162,255,0.1)}

    .timeline, .date-list{scrollbar-width: thin; scrollbar-color: rgba(122,162,255,0.55) rgba(255,255,255,0.04); scrollbar-gutter: stable both-edges}
    .timeline::-webkit-scrollbar, .date-list::-webkit-scrollbar{width:12px}
    .timeline::-webkit-scrollbar-track, .date-list::-webkit-scrollbar-track{background: rgba(255,255,255,0.04); border-radius:999px}
    .timeline::-webkit-scrollbar-thumb, .date-list::-webkit-scrollbar-thumb{
      background: linear-gradient(180deg, rgba(122,162,255,0.75), rgba(134,247,211,0.75));
      border-radius:999px; border:2px solid rgba(11,16,32,0.9);
      box-shadow: 0 4px 10px rgba(8,12,24,0.35);
    }
    .timeline::-webkit-scrollbar-thumb:hover, .date-list::-webkit-scrollbar-thumb:hover{background: linear-gradient(180deg, rgba(122,162,255,0.9), rgba(134,247,211,0.9))}

    .form{display:grid; grid-template-columns: repeat(8, minmax(0,1fr)); gap:12px; align-items:end}
    .field{display:flex; flex-direction:column; gap:8px}
    .field-span-2{grid-column: span 2;}
    .field-span-8{grid-column: span 8;}
    .form-actions{grid-column: span 8; display:flex; justify-content:flex-end; gap:10px}
    .field label{font-size:12px; color:var(--muted)}
    input[type="text"], input[type="date"], input[type="time"], select, textarea{
      width:100%; padding:12px 12px; border-radius: 12px; background: rgba(255,255,255,0.06);
      border:1px solid var(--panel-strong); color:var(--text); outline:none; transition: .15s border-color, .15s box-shadow;
    }
    /* 下拉框保持与输入框一致的深色风格 */
    select{
      background: rgba(255,255,255,0.06);
      color: var(--text);
      font-weight:500;
    }
    select option{
      background: rgba(11,16,32,0.95);
      color: var(--text);
    }
    select option:checked{background:#6b8cff; color:#041232}
    textarea{min-height:44px; resize: vertical}
    input:focus, select:focus, textarea:focus{border-color: var(--primary); box-shadow: 0 0 0 3px rgba(122,162,255,0.25)}

    .timeline-wrap{display:grid; grid-template-columns: minmax(0, 1fr) 320px; gap:20px; align-items:stretch;}

    /* 统一对齐：使用固定 gutter，将竖线置于 gutter 中心，事件卡片从 gutter 右侧开始 */
    .timeline{position:relative; overflow:auto; height: calc(100vh - 140px); padding: 10px 16px 10px 16px}
    .time-line{position:absolute; left: calc(var(--gutter)/2); top:0; bottom:0; width:4px; background: var(--panel-strong); border-radius:8px}
    .timeline-inner{margin-left: var(--gutter);}

    .group{position:relative; margin: 0 0 26px 0}
    .date-sticky{position:sticky; top:6px; display:inline-block; margin-left: calc(-1 * (var(--gutter) - 16px)); padding:6px 12px; border-radius:12px;
      background: rgba(122,162,255,0.12); border:1px solid rgba(122,162,255,0.35); color:#cfe0ff; font-size:12px; backdrop-filter: blur(6px)}

    .event{position:relative; background: rgba(255,255,255,0.06); border:1px solid var(--panel-strong); border-radius:16px; padding:12px 14px; margin:12px 0 12px 0; transition:.15s transform,.15s background,.15s box-shadow; display:flex; flex-direction:column; gap:12px}
    .event:hover{transform: translateY(-1px); background: rgba(255,255,255,0.09)}
    /* 让圆点中心严格落在时间线中心 */
    .event::before{content:""; position:absolute; left: calc(-1 * var(--gutter)/2 - 8px); top:18px; width:16px; height:16px; border-radius:50%; background: var(--panel-strong); outline:4px solid rgba(255,255,255,0.06);}    
    .event[data-type="日常"]::before{background: #7aa2ff}
    .event[data-type="额外"]::before{background: #86f7d3}
    .event[data-type="游戏"]::before{background: #ffb37a}
    .event[data-type="运动"]::before{background: #86f49b}
    .event[data-type="学习"]::before{background: #ff7aa3}
    .event.event--focus{background: rgba(255,255,255,0.12); box-shadow: 0 0 0 2px rgba(122,162,255,0.45);}

    .event-content{display:flex; flex-direction:column; gap:8px}
    .event-title{margin:0; font-weight:650; font-size:1.05rem; letter-spacing:0.2px; color:var(--text)}
    .event-notes{font-size:0.95rem; color:#edf1ff; line-height:1.6}
    .event-footer{display:flex; align-items:center; gap:10px; flex-wrap:wrap; font-size:12px}
    .event-meta{font-size:12px; color:var(--muted)}
    .event-actions{display:flex; gap:6px; margin-left:auto}
    .event-actions .btn{padding:6px 12px; font-size:12px}
    .type-chip{
      display:inline-flex;
      align-items:center;
      gap:6px;
      font-size:11px;
      padding:4px 10px;
      border-radius:999px;
      background: rgba(255,255,255,0.08);
      border:1px solid var(--panel-strong);
      color:var(--muted);
      white-space:nowrap;
      transition:.15s transform,.15s box-shadow,.15s background;
    }
    .type-chip[data-type="日常"]{background: rgba(122,162,255,0.18); border-color: rgba(122,162,255,0.5); color:#dbe5ff;}
    .type-chip[data-type="额外"]{background: rgba(134,247,211,0.18); border-color: rgba(134,247,211,0.45); color:#dbfff3;}
    .type-chip[data-type="游戏"]{background: rgba(255,179,122,0.18); border-color: rgba(255,179,122,0.45); color:#ffe8d9;}
    .type-chip[data-type="运动"]{background: rgba(134,244,155,0.18); border-color: rgba(134,244,155,0.45); color:#e0ffe7;}
    .type-chip[data-type="学习"]{background: rgba(255,122,163,0.18); border-color: rgba(255,122,163,0.5); color:#ffdbe8;}
    .type-chip .type-chip-count{font-size:10px; opacity:0.8;}
    .type-chip--interactive{
      cursor:pointer;
    }
    .type-chip--interactive:not(:disabled){
      box-shadow: inset 0 0 0 1px rgba(255,255,255,0.05);
    }
    .type-chip--interactive:not(:disabled):hover{transform: translateY(-1px); box-shadow: inset 0 0 0 1px rgba(255,255,255,0.18), 0 8px 16px rgba(8,12,24,0.4);}
    .type-chip--interactive:disabled{opacity:0.4; cursor:not-allowed;}
    .type-chip--mini{font-size:10px; padding:3px 8px;}
    .event-notes{white-space: pre-wrap}

    .rightbar{position:sticky; top:92px; height: calc(100vh - 140px)}
    .rb-card{height:100%; padding:14px}
    .rb-head{display:flex; align-items:center; justify-content:space-between; margin-bottom:8px}
    .rb-search{margin-bottom:10px}
    .date-list{overflow:auto; height: calc(100% - 90px); padding-right:4px}
    .type-quick{display:flex; flex-wrap:wrap; gap:8px; margin:10px 0 6px;}
    .date-item{display:flex; flex-direction:column; gap:8px; align-items:flex-start; padding:8px 10px; margin:6px 0; border-radius:12px; cursor:default; transition:.15s background;border:1px solid transparent}
    .date-item:hover{background: rgba(255,255,255,0.06); border-color: var(--panel-strong)}
    .date-item small{color: var(--muted)}
    .date-item-head{display:flex; align-items:center; justify-content:space-between; width:100%; background:none; border:none; color:inherit; font:inherit; padding:0; cursor:pointer;}
    .date-item-head:focus{outline:1px solid rgba(122,162,255,0.45); outline-offset:2px;}
    .date-item-tags{display:flex; flex-wrap:wrap; gap:6px;}

    .empty{padding:16px; color:var(--muted)}
    .help{font-size:12px; color:var(--muted)}

    @media (max-width: 1024px){
      .app{grid-template-columns: 1fr}
      header{top:0; margin:calc(-1 * clamp(16px, 4vw, 24px)) calc(-1 * clamp(16px, 4vw, 24px)) 16px; padding:16px clamp(16px, 4vw, 24px) 18px;}
      .timeline-wrap{grid-template-columns: 1fr}
      .timeline{height:auto; max-height:none}
      .rightbar{position:static; height:auto}
    }

    @media (max-width: 768px){
      body{font-size:0.95rem;}
      .titlebar{flex-direction:column; align-items:flex-start; gap:12px;}
      .actions{width:100%; justify-content:flex-start;}
      .btn{padding:9px 14px; font-size:0.95rem;}
      .timeline{padding:14px 14px 14px 20px;}
      .rb-card{padding:12px;}
      .rb-search{width:100%;}
    }

    @media (max-width: 600px){
      .app{gap:16px;}
      header{position:static; margin:-16px -16px 12px; padding:14px 16px 18px; border-radius:0;}
      .actions{gap:8px;}
      .actions .btn{flex:1 1 calc(50% - 8px); min-width:140px; text-align:center;}
      .timeline{padding:14px 10px 14px 18px;}
      .timeline-inner{margin-left: calc(var(--gutter) - 20px);}
      .event{padding:14px; gap:10px;}
      .event-title{font-size:1rem;}
      .event-footer{gap:8px;}
      .event-actions{width:100%; justify-content:flex-end;}
      .type-chip{font-size:10px;}
      .rightbar{order:-1;}
      .rb-card{padding:12px 12px 16px;}
      .type-quick{gap:6px;}
      .form{grid-template-columns: 1fr;}
      .field-span-2,
      .field-span-8,
      .form-actions{grid-column: span 1;}
      .form-actions{flex-direction:column; align-items:stretch;}
      .form-actions .btn{width:100%;}
      .modal{align-items:flex-start; padding:16px;}
      .modal-panel{width:100%; max-width:none; height:100%; border-radius:0; margin:0; padding:22px 18px; overflow-y:auto;}
      .modal-panel::before{inset:-40% 5% auto;}
      .modal-panel--sm{width:100%;}
      .modal-head{flex-direction:column; align-items:flex-start; gap:10px;}
      .modal-actions{flex-direction:column; align-items:stretch;}
      .modal-actions .btn{width:100%;}
      .date-sticky{font-size:11px;}
      .actions .btn.primary{flex-basis:100%;}
    }
  </style>
</head>
<body>
  <div class="app">
    <header class="card">
      <div class="titlebar">
        <h1>时间轴记录</h1>
        <div class="actions">
          <button class="btn" id="btnToday" title="快速回到今天">回到今天</button>
          <button class="btn" id="btnExport" title="导出数据">导出</button>
          <input type="file" id="fileImport" accept=".xls,application/vnd.ms-excel,text/html" hidden>
          <button class="btn" id="btnImport" title="导入数据（与当前缓存合并）">导入</button>
          <button class="btn danger" id="btnClear" title="清空所有本地数据">清空数据</button>
          <button class="btn primary" id="btnAdd" title="添加事件">添加事件</button>
        </div>
      </div>
      <!-- 表单改为弹窗，不在头部常驻显示 -->
    </header>

    <div class="timeline-wrap">
      <section class="timeline card" id="timeline">
        <div class="time-line"></div>
        <div class="timeline-inner">
          <div id="timelineContent"></div>
        </div>
      </section>
      <aside class="rightbar">
        <div class="rb-card card">
          <div class="rb-head">
            <strong>按日期跳转</strong>
            <button class="btn" id="btnCollapseDates" style="padding:6px 10px">折叠/展开</button>
          </div>
          <div class="rb-search">
            <input id="dateSearch" type="text" placeholder="搜索日期或关键字...">
          </div>
          <div class="type-quick" id="typeQuick"></div>
          <div class="date-list" id="dateList"></div>
        </div>
      </aside>
  </div>

  <!-- 弹窗：复用原表单结构与样式，仅改变呈现方式为模态 -->
  <div class="modal" id="modalAdd" aria-hidden="true">
    <div class="card modal-panel" role="dialog" aria-modal="true">
      <div class="modal-head">
        <strong class="modal-title" id="modalTitle">添加事件</strong>
        <button class="btn" id="btnCloseModal" aria-label="关闭" style="padding:6px 10px">关闭</button>
      </div>
      <form id="eventForm" class="form">
        <div class="field field-span-2">
          <label for="date">日期</label>
          <input id="date" type="date" required>
        </div>
        <div class="field field-span-2">
          <label for="time">时间</label>
          <input id="time" type="time" required>
        </div>
        <div class="field field-span-2">
          <label for="type">类型</label>
          <select id="type" required>
            <option>日常</option>
            <option>额外</option>
            <option>游戏</option>
            <option>运动</option>
            <option>学习</option>
          </select>
        </div>
        <div class="field field-span-8">
          <label for="title">事件标题</label>
          <input id="title" type="text" placeholder="做了什么？（必填）" required>
        </div>
        <div class="field field-span-8">
          <label for="notes">备注</label>
          <textarea id="notes" placeholder="可选"></textarea>
        </div>
        <div class="form-actions">
          <button type="button" class="btn" id="btnCancel">取消</button>
          <button class="btn primary" id="btnSubmit" type="submit">添加事件</button>
        </div>
      </form>
      <div class="help" style="margin-top:8px">数据仅保存在本地浏览器缓存。导入 XLS 会与当前缓存合并；导出的 XLS 可直接用 Excel 打开与编辑。</div>
    </div>
  </div>

  <div class="modal" id="modalConfirm" aria-hidden="true">
    <div class="card modal-panel modal-panel--sm" role="dialog" aria-modal="true" aria-labelledby="confirmTitle">
      <div class="modal-head">
        <div style="display:flex; align-items:center; gap:12px">
          <span class="modal-icon" aria-hidden="true">⚠️</span>
          <strong class="modal-title" id="confirmTitle">确认操作</strong>
        </div>
        <button class="btn" id="btnCloseConfirm" aria-label="关闭提示" style="padding:6px 10px">关闭</button>
      </div>
      <div class="modal-body" id="confirmMessage">确定执行该操作吗？</div>
      <div class="modal-actions">
        <button class="btn" type="button" id="btnConfirmCancel">取消</button>
        <button class="btn" type="button" id="btnConfirmOk">确定</button>
      </div>
    </div>
  </div>

  <script>
    /*** 数据层 ***/
    const KEY = 'timelineEventsV1';
    const TYPES = ['日常','额外','游戏','运动','学习'];

    function loadEvents(){
      try{ return JSON.parse(localStorage.getItem(KEY) || '[]').map(e=>({...e, datetime: new Date(e.datetime)})); }
      catch{ return [] }
    }
    function saveEvents(list){
      // 存储为 ISO 字符串
      const sanitized = list.map(e=>({...e, datetime: (new Date(e.datetime)).toISOString()}));
      localStorage.setItem(KEY, JSON.stringify(sanitized));
    }

    /*** 工具 ***/
    const fmt = new Intl.DateTimeFormat('zh-CN', {
      dateStyle: 'medium', timeStyle: 'short'
    });
    const fmtDate = (d)=>{
      const year = d.getFullYear();
      const month = String(d.getMonth()+1).padStart(2,'0');
      const day = String(d.getDate()).padStart(2,'0');
      return `${year}-${month}-${day}`;
    }; // YYYY-MM-DD (local time)
    const fmtTime = (d)=> d.toTimeString().slice(0,5);
    const stripBom = (text='')=> String(text).replace(/^\ufeff/,'');

    function parseDateTimeParts(dateStr='', timeStr=''){
      const dateClean = stripBom(dateStr).trim();
      if(!dateClean) return null;
      const segments = dateClean.replace(/[./]/g,'-').split('-').filter(Boolean);
      if(segments.length < 3) return null;
      const [y, m, d] = segments;
      const isoDate = `${y.padStart(4,'0')}-${m.padStart(2,'0')}-${d.padStart(2,'0')}`;
      let timeClean = stripBom(timeStr).trim();
      if(!timeClean){
        timeClean = '00:00:00';
      }else{
        timeClean = timeClean.replace(/[.]/g,':');
        const match = timeClean.match(/^(\d{1,2})(?::(\d{1,2}))?(?::(\d{1,2}))?$/);
        if(match){
          const h = match[1].padStart(2,'0');
          const min = (match[2]??'0').padStart(2,'0');
          const sec = (match[3]??'0').padStart(2,'0');
          timeClean = `${h}:${min}:${sec}`;
        }else{
          return null;
        }
      }
      const dt = new Date(`${isoDate}T${timeClean}`);
      if(isNaN(dt)) return null;
      return dt;
    }

    function uid(){return Math.random().toString(36).slice(2)+Date.now().toString(36)}

    function eventKey(ev){
      const dt = new Date(ev.datetime);
      return [dt.getTime(), (ev.type||'').trim(), (ev.title||'').trim()].join('|');
    }

    function mergeEvents(existing=[], incoming=[]){
      const map = new Map();
      const stats = {added: 0, updated: 0};
      existing.forEach(ev=>{
        const key = eventKey(ev);
        map.set(key, {...ev});
      });
      incoming.forEach(ev=>{
        const key = eventKey(ev);
        const prev = map.get(key);
        const nextItem = {...ev};
        if(prev){
          nextItem.id = prev.id;
          const prevTime = new Date(prev.datetime).getTime();
          const nextTime = new Date(nextItem.datetime).getTime();
          const changed = prevTime !== nextTime || prev.type !== nextItem.type || (prev.title||'').trim() !== (nextItem.title||'').trim() || (prev.notes||'').trim() !== (nextItem.notes||'').trim();
          if(changed) stats.updated += 1;
        }else{
          if(!nextItem.id) nextItem.id = uid();
          stats.added += 1;
        }
        map.set(key, nextItem);
      });
      return {list: Array.from(map.values()), stats};
    }

    /*** 视图渲染（增量） ***/
    let allEvents = loadEvents().sort((a,b)=> b.datetime - a.datetime);
    let chunk = 40; // 每次渲染的事件数
    let renderedCount = 0;
    let dateAnchors = {}; // date -> element id

    const timelineContent = document.getElementById('timelineContent');
    const timeline = document.getElementById('timeline');
    const dateListEl = document.getElementById('dateList');
    const typeQuickEl = document.getElementById('typeQuick');

    function groupByDate(events){
      const map = new Map();
      for(const e of events){
        const d = fmtDate(new Date(e.datetime));
        if(!map.has(d)) map.set(d, []);
        map.get(d).push(e);
      }
      return map;
    }

    function ensureGroup(dateStr){
      let group = document.getElementById('grp-'+dateStr);
      if(group) return group;
      group = document.createElement('div');
      group.className = 'group';
      group.id = 'grp-'+dateStr;
      const sticky = document.createElement('div');
      sticky.className = 'date-sticky';
      sticky.textContent = dateStr;
      group.appendChild(sticky);
      timelineContent.appendChild(group);
      dateAnchors[dateStr] = group.id;
      return group;
    }

    function renderMore(){
      const next = allEvents.slice(renderedCount, renderedCount + chunk);
      if(next.length===0) return;
      const byDate = groupByDate(next);
      // 保持倒序（新到旧）
      const dates = Array.from(byDate.keys()).sort((a,b)=> a<b?1:-1);
      for(const d of dates){
        const group = ensureGroup(d);
        for(const e of byDate.get(d)){
          const card = document.createElement('div');
          card.className = 'event';
          card.id = 'event-'+e.id;
          card.dataset.type = e.type;
          card.innerHTML = `
            <div class="event-content">
              <div class="event-title">${escapeHtml(e.title)}</div>
              ${e.notes?`<div class="event-notes">${escapeHtml(e.notes)}</div>`:''}
            </div>
            <div class="event-footer">
              <div class="event-meta">${fmtTime(new Date(e.datetime))} · <span class="type-chip" data-type="${e.type}">${e.type}</span></div>
              <div class="event-actions">
                <button class="btn" data-act="edit" data-id="${e.id}">编辑</button>
                <button class="btn" data-act="del" data-id="${e.id}">删除</button>
              </div>
            </div>
          `;
          group.appendChild(card);
        }
      }
      renderedCount += next.length;
    }

    function rebuildAll(){
      // 重建整个时间线（例如导入或清空后）
      timelineContent.innerHTML = '';
      dateAnchors = {};
      renderedCount = 0;
      renderMore();
      buildDateList();
      buildTypeQuicklinks();
    }

    // 无限下滑加载
    timeline.addEventListener('scroll', ()=>{
      const nearBottom = timeline.scrollTop + timeline.clientHeight >= timeline.scrollHeight - 100;
      if(nearBottom) renderMore();
    });

    // 右侧日期列表
    function buildDateList(filter=''){
      const grouped = allEvents.reduce((acc,e)=>{
        const d = fmtDate(new Date(e.datetime));
        if(!acc[d]) acc[d] = [];
        acc[d].push(e);
        return acc;
      }, {});
      const dates = Object.keys(grouped).sort((a,b)=> a<b?1:-1);
      const filterText = filter.trim().toLowerCase();
      dateListEl.innerHTML = '';
      if(dates.length===0){
        dateListEl.innerHTML = `<div class="empty">暂无数据。添加一些事件吧～</div>`; return;
      }
      let appended = 0;
      dates.forEach(d=>{
        const eventsForDate = grouped[d] || [];
        const matchedEvents = filterText
          ? eventsForDate.filter(ev => (ev.title+"\n"+(ev.notes||'')).toLowerCase().includes(filterText))
          : eventsForDate;
        if(matchedEvents.length===0) return;
        appended++;
        const item = document.createElement('div');
        item.className = 'date-item';
        const headBtn = document.createElement('button');
        headBtn.type = 'button';
        headBtn.className = 'date-item-head';
        headBtn.innerHTML = `<span>${d}</span><small>${matchedEvents.length}</small>`;
        headBtn.addEventListener('click', ()=> jumpToDate(d));
        const tagsWrap = document.createElement('div');
        tagsWrap.className = 'date-item-tags';
        const typesForDate = TYPES.filter(type=> matchedEvents.some(ev=>ev.type===type));
        typesForDate.forEach(type=>{
          const btn = document.createElement('button');
          btn.type = 'button';
          btn.className = 'type-chip type-chip--mini type-chip--interactive';
          btn.dataset.type = type;
          btn.textContent = type;
          btn.title = `${d} · ${type}`;
          btn.addEventListener('click', (evt)=>{ evt.stopPropagation(); jumpToDateType(d, type); });
          tagsWrap.appendChild(btn);
        });
        item.appendChild(headBtn);
        if(typesForDate.length){
          item.appendChild(tagsWrap);
        }
        dateListEl.appendChild(item);
      });
      if(appended===0){
        dateListEl.innerHTML = `<div class="empty">未找到匹配的日期</div>`;
      }
    }

    function buildTypeQuicklinks(){
      if(!typeQuickEl) return;
      const typeCounts = allEvents.reduce((acc, ev)=>{
        acc[ev.type] = (acc[ev.type] || 0) + 1;
        return acc;
      }, {});
      typeQuickEl.innerHTML = '';
      TYPES.forEach(type=>{
        const count = typeCounts[type] || 0;
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'type-chip type-chip--interactive';
        btn.dataset.type = type;
        btn.innerHTML = count ? `${type}<span class="type-chip-count">${count}</span>` : type;
        btn.disabled = count === 0;
        btn.title = count === 0 ? `暂无 ${type} 事件` : `查看最新的 ${type} 事件`;
        btn.addEventListener('click', ()=> jumpToType(type));
        typeQuickEl.appendChild(btn);
      });
    }

    function ensureEventElement(eventId){
      let el = document.getElementById('event-'+eventId);
      while(!el && renderedCount < allEvents.length){
        renderMore();
        el = document.getElementById('event-'+eventId);
      }
      return el;
    }

    function focusEvent(el){
      if(!el) return;
      document.querySelectorAll('.event--focus').forEach(node=>{
        if(node!==el) node.classList.remove('event--focus');
      });
      el.classList.add('event--focus');
      setTimeout(()=>{ el.classList.remove('event--focus'); }, 1600);
    }

    function jumpToType(type){
      const target = allEvents.find(ev=>ev.type===type);
      if(!target) return;
      const el = ensureEventElement(target.id);
      if(el){
        el.scrollIntoView({behavior:'smooth', block:'center'});
        focusEvent(el);
      }
    }

    function jumpToDateType(dateStr, type){
      const target = allEvents.find(ev=>fmtDate(new Date(ev.datetime))===dateStr && ev.type===type);
      if(!target) return;
      const el = ensureEventElement(target.id);
      if(el){
        el.scrollIntoView({behavior:'smooth', block:'center'});
        focusEvent(el);
      }
    }

    function jumpToDate(dateStr){
      const id = dateAnchors[dateStr];
      if(id){
        const el = document.getElementById(id);
        el?.scrollIntoView({behavior:'smooth', block:'start'});
      } else {
        // 尚未渲染到该日期，则逐步渲染直到包含
        while(!dateAnchors[dateStr] && renderedCount < allEvents.length){
          renderMore();
        }
        const el2 = document.getElementById(dateAnchors[dateStr]);
        el2?.scrollIntoView({behavior:'smooth', block:'start'});
      }
    }

    // 回到今天
    document.getElementById('btnToday').addEventListener('click', ()=>{
      const today = new Date();
      const ds = fmtDate(today);
      jumpToDate(ds);
    });

    // 折叠
    let collapsed = false;
    document.getElementById('btnCollapseDates').addEventListener('click',()=>{
      collapsed = !collapsed;
      dateListEl.style.display = collapsed ? 'none' : 'block';
    });

    document.getElementById('dateSearch').addEventListener('input', (e)=>{
      buildDateList(e.target.value);
    });

    /*** 表单 ***/
    const form = document.getElementById('eventForm');
    const dateInput = document.getElementById('date');
    const timeInput = document.getElementById('time');
    const typeInput = document.getElementById('type');
    const titleInput = document.getElementById('title');
    const notesInput = document.getElementById('notes');

    function initNow(){
      const now = new Date();
      const tzOffset = now.getTimezoneOffset();
      // 正常填充本地日期与时间
      dateInput.value = fmtDate(now);
      timeInput.value = ("0"+now.getHours()).slice(-2)+":"+("0"+now.getMinutes()).slice(-2);
    }

    form.addEventListener('submit', (e)=>{
      e.preventDefault();
      try{
        const d = dateInput.value;
        const t = timeInput.value;
        const dt = new Date(d + 'T' + t + ':00');
        if(isNaN(dt)) throw new Error('时间无效');
        const payload = {
          datetime: dt,
          type: typeInput.value,
          title: titleInput.value.trim(),
          notes: notesInput.value.trim()
        };
        if(!payload.title) { alert('请填写事件标题'); return; }
        if(editingId){
          const idx = allEvents.findIndex(x=>x.id===editingId);
          if(idx===-1) throw new Error('要编辑的事件不存在');
          allEvents[idx] = {...allEvents[idx], ...payload};
        }else{
          allEvents.push({
            id: uid(),
            ...payload
          });
        }
        allEvents.sort((a,b)=> b.datetime - a.datetime);
        saveEvents(allEvents);
        // 更聪明的增量：重建即可（简单稳妥）
        rebuildAll();
        if(!editingId){
          // 清空标题与备注
          titleInput.value='';
          notesInput.value='';
        }
        closeModal();
        editingId = null;
      }catch(err){
        alert('添加失败：'+err.message)
      }
    });

    // 事件编辑与删除（事件委托）
    const timelineInner = document.querySelector('.timeline-inner');
    timelineInner.addEventListener('click', async (e)=>{
      const btn = e.target.closest('button[data-act]');
      if(!btn) return;
      const id = btn.getAttribute('data-id');
      const act = btn.getAttribute('data-act');
      if(act==='del'){
        const ok = await showConfirm('确定删除该事件？', {
          title: '删除事件',
          confirmText: '删除',
          cancelText: '保留',
          confirmVariant: 'danger'
        });
        if(!ok) return;
        allEvents = allEvents.filter(x=>x.id!==id);
        saveEvents(allEvents);
        rebuildAll();
      } else if(act==='edit'){
        const ev = allEvents.find(x=>x.id===id);
        if(!ev) return;
        openEditModal(ev);
      }
    });

    // 导出 XLS（Excel 兼容）
    document.getElementById('btnExport').addEventListener('click', ()=>{
      if(allEvents.length===0){ alert('暂无数据可导出'); return; }
      const rows = allEvents
        .slice()
        .sort((a,b)=> a.datetime - b.datetime)
        .map(e=>{
          const dt = new Date(e.datetime);
          return `<tr>`+
            `<td>${escapeHtml(fmtDate(dt))}</td>`+
            `<td>${escapeHtml(fmtTime(dt))}</td>`+
            `<td>${escapeHtml(e.type)}</td>`+
            `<td>${escapeHtml(e.title)}</td>`+
            `<td>${escapeHtml(e.notes||'')}</td>`+
          `</tr>`;
        })
        .join('');
      const table = `<!DOCTYPE html><html><head><meta charset="utf-8" />`+
        `<style>table{border-collapse:collapse;}td,th{border:1px solid #999;padding:4px 6px;white-space:pre-wrap;}</style>`+
        `</head><body><table><thead><tr>`+
        `<th>日期</th><th>时间</th><th>类型</th><th>标题</th><th>备注</th>`+
        `</tr></thead><tbody>${rows}</tbody></table></body></html>`;
      const blob = new Blob([table], {type: 'application/vnd.ms-excel;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'timeline.xls';
      document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(url);
    });

    // 导入 XLS/CSV（覆盖缓存）
    document.getElementById('btnImport').addEventListener('click', ()=>{
      document.getElementById('fileImport').click();
    });
    document.getElementById('fileImport').addEventListener('change', (e)=>{
      const file = e.target.files?.[0];
      if(!file) return;
      const reader = new FileReader();
      reader.onload = async ()=>{
        try{
          const text = String(reader.result);
          const imported = parseImportedData(text);
          if(imported.length===0){
            alert(allEvents.length ? '未检测到有效数据，已保留当前缓存。' : '未检测到有效数据。');
            e.target.value = '';
            return;
          }
          const ok = await showConfirm(`将导入 ${imported.length} 条记录，与当前 ${allEvents.length} 条记录合并。继续？`, {
            title: '导入数据',
            confirmText: '导入',
            cancelText: '取消',
            confirmVariant: 'primary'
          });
          if(!ok) return;
          const {list: merged, stats} = mergeEvents(allEvents, imported);
          allEvents = merged.sort((a,b)=> b.datetime - a.datetime);
          saveEvents(allEvents);
          rebuildAll();
          const summaryParts = [];
          if(stats.added) summaryParts.push(`新增 ${stats.added} 条`);
          if(stats.updated) summaryParts.push(`更新 ${stats.updated} 条`);
          const summary = summaryParts.length ? summaryParts.join('，') : '数据保持不变';
          alert(`导入完成：${summary}。`);
          e.target.value = '';
        }catch(err){
          alert('导入失败：'+err.message);
        }
      };
      reader.readAsText(file);
    });

    // 清空
    document.getElementById('btnClear').addEventListener('click', async ()=>{
      const ok = await showConfirm('确定清空所有本地数据？此操作不可恢复。', {
        title: '清空所有数据',
        confirmText: '清空',
        cancelText: '取消',
        confirmVariant: 'danger'
      });
      if(!ok) return;
      allEvents = [];
      saveEvents(allEvents);
      rebuildAll();
    });

    /*** 辅助：CSV/HTML ***/
    function parseImportedData(rawText=''){
      const text = stripBom(rawText).trim();
      if(!text) throw new Error('文件为空');
      if(text.startsWith('<')){
        return parseHtmlTable(text);
      }
      return parseCsv(text);
    }
    function parseHtmlTable(html){
      const parser = new DOMParser();
      const doc = parser.parseFromString(html, 'text/html');
      const table = doc.querySelector('table');
      if(!table) throw new Error('未找到表格数据');
      const rows = Array.from(table.querySelectorAll('tr'));
      if(rows.length<=1) throw new Error('没有有效数据行');
      const headerCells = Array.from(rows[0].cells).map(td=>td.textContent.trim());
      const lowerHeader = headerCells.map(c=>c.toLowerCase());
      const isZh = headerCells.length >= 5 && headerCells[0] === '日期' && headerCells[1] === '时间' && headerCells[2] === '类型';
      const isEn = lowerHeader.length >= 4 && lowerHeader[0] === 'datetime' && lowerHeader[1] === 'type';
      if(!isZh && !isEn) throw new Error('列头需包含 日期,时间,类型,标题,备注');
      const imported = [];
      for(let i=1;i<rows.length;i++){
        const cells = Array.from(rows[i].cells).map(td=>td.textContent ?? '');
        if(cells.every(v=>!v.trim())) continue;
        const item = buildItemFromCells(cells, isZh);
        if(item) imported.push(item);
      }
      return imported;
    }
    function parseCsv(text){
      const lines = text.split(/\r?\n/).filter(line=>line.trim().length>0);
      if(lines.length<=1) throw new Error('文件为空');
      const headerCells = smartCsvSplit(lines[0]).map(c=>stripBom(c).trim());
      const lowerHeader = headerCells.map(c=>c.toLowerCase());
      const isZh = headerCells.length >= 5 && headerCells[0] === '日期' && headerCells[1] === '时间' && headerCells[2] === '类型';
      const isEn = lowerHeader.length >= 4 && lowerHeader[0] === 'datetime' && lowerHeader[1] === 'type';
      if(!isZh && !isEn){
        throw new Error('列头需包含 日期,时间,类型,标题,备注');
      }
      const imported = [];
      for(let i=1;i<lines.length;i++){
        const cols = smartCsvSplit(lines[i]);
        const item = buildItemFromCells(cols, isZh);
        if(item) imported.push(item);
      }
      return imported;
    }
    function buildItemFromCells(cols, isZh){
      let item = null;
      if(isZh){
        const datePart = cols[0] ?? '';
        const timePart = cols[1] ?? '';
        const typePart = stripBom(cols[2] ?? '').trim();
        const titlePart = cols[3] ?? '';
        const notesPart = cols[4] ?? '';
        const d = parseDateTimeParts(datePart, timePart);
        if(!d) return null;
        if(!TYPES.includes(typePart)) return null;
        item = {
          id: uid(),
          datetime: d,
          type: typePart,
          title: stripBom(titlePart).trim(),
          notes: stripBom(notesPart).trim()
        };
      }else{
        const [dt, type, title, notes] = cols;
        const d = new Date(stripBom(dt));
        if(isNaN(d)) return null;
        const typePart = stripBom(type||'').trim();
        if(!TYPES.includes(typePart)) return null;
        item = {
          id: uid(),
          datetime: d,
          type: typePart,
          title: stripBom(title||'').trim(),
          notes: stripBom(notes||'').trim()
        };
      }
      if(!item.title) return null;
      return item;
    }
    function smartCsvSplit(line){
      // 解析带引号的 CSV 行
      const out = []; let cur = ''; let q = false;
      for(let i=0;i<line.length;i++){
        const ch = line[i];
        if(ch==='"'){
          if(q && line[i+1]==='"'){ cur+='"'; i++; }
          else q = !q;
        }else if(ch===',' && !q){ out.push(cur); cur=''; }
        else { cur += ch; }
      }
      out.push(cur);
      return out;
    }
    function escapeHtml(str=''){
      return String(str)
        .replaceAll('&','&amp;')
        .replaceAll('<','&lt;')
        .replaceAll('>','&gt;')
        .replaceAll('"','&quot;')
        .replaceAll("'",'&#39;');
    }
    // —— 弹窗交互 ——
    const modalAdd = document.getElementById('modalAdd');
    const btnAdd = document.getElementById('btnAdd');
    const btnCloseModal = document.getElementById('btnCloseModal');
    const btnCancel = document.getElementById('btnCancel');
    const modalTitle = document.getElementById('modalTitle');
    const btnSubmit = document.getElementById('btnSubmit');
    const modalConfirm = document.getElementById('modalConfirm');
    const confirmTitleEl = document.getElementById('confirmTitle');
    const confirmMessageEl = document.getElementById('confirmMessage');
    const btnConfirmOk = document.getElementById('btnConfirmOk');
    const btnConfirmCancel = document.getElementById('btnConfirmCancel');
    const btnCloseConfirm = document.getElementById('btnCloseConfirm');

    function openOverlay(el){
      el.classList.add('active');
      el.setAttribute('aria-hidden','false');
      document.body.classList.add('modal-open');
    }
    function closeOverlay(el){
      el.classList.remove('active');
      el.setAttribute('aria-hidden','true');
      if(!modalAdd.classList.contains('active') && !modalConfirm.classList.contains('active')){
        document.body.classList.remove('modal-open');
      }
    }

    let confirmResolver = null;

    function settleConfirm(result){
      if(!modalConfirm.classList.contains('active') && confirmResolver===null) return;
      closeOverlay(modalConfirm);
      if(confirmResolver){
        const resolve = confirmResolver;
        confirmResolver = null;
        resolve(result);
      }
    }

    function showConfirm(message, {title='确认操作', confirmText='确定', cancelText='取消', confirmVariant='primary'} = {}){
      if(modalConfirm.classList.contains('active')){
        settleConfirm(false);
      }
      confirmTitleEl.textContent = title;
      confirmMessageEl.textContent = message;
      btnConfirmOk.textContent = confirmText;
      btnConfirmCancel.textContent = cancelText;
      btnConfirmOk.classList.remove('primary','danger');
      btnConfirmOk.classList.add(confirmVariant === 'danger' ? 'danger' : 'primary');
      openOverlay(modalConfirm);
      setTimeout(()=>{ btnConfirmOk?.focus(); }, 0);
      return new Promise((resolve)=>{
        confirmResolver = resolve;
      });
    }

    btnConfirmOk?.addEventListener('click', ()=> settleConfirm(true));
    btnConfirmCancel?.addEventListener('click', ()=> settleConfirm(false));
    btnCloseConfirm?.addEventListener('click', ()=> settleConfirm(false));
    modalConfirm?.addEventListener('click', (e)=>{ if(e.target === modalConfirm) settleConfirm(false); });

    let editingId = null;

    function openAddModal(){
      editingId = null;
      modalTitle.textContent = '添加事件';
      btnSubmit.textContent = '添加事件';
      btnSubmit.dataset.mode = 'add';
      form.reset();
      openOverlay(modalAdd);
      initNow();
      typeInput.value = TYPES[0];
      notesInput.value = '';
      setTimeout(()=>{ try{ document.getElementById('title').focus(); }catch{} }, 0);
    }
    function openEditModal(ev){
      editingId = ev.id;
      modalTitle.textContent = '编辑事件';
      btnSubmit.textContent = '保存修改';
      btnSubmit.dataset.mode = 'edit';
      openOverlay(modalAdd);
      const dt = new Date(ev.datetime);
      dateInput.value = fmtDate(dt);
      timeInput.value = fmtTime(dt);
      typeInput.value = ev.type;
      titleInput.value = ev.title;
      notesInput.value = ev.notes || '';
      setTimeout(()=>{ try{ document.getElementById('title').focus(); }catch{} }, 0);
    }
    function closeModal(){
      closeOverlay(modalAdd);
      editingId = null;
      btnSubmit.dataset.mode = 'add';
      form.reset();
      typeInput.value = TYPES[0];
      notesInput.value = '';
    }

    btnAdd?.addEventListener('click', openAddModal);
    btnCloseModal?.addEventListener('click', closeModal);
    btnCancel?.addEventListener('click', closeModal);
    modalAdd.addEventListener('click', (e)=>{ if(e.target === modalAdd) closeModal(); });
    window.addEventListener('keydown', (e)=>{
      if(e.key==='Escape'){
        if(modalConfirm.classList.contains('active')) settleConfirm(false);
        else if(modalAdd.classList.contains('active')) closeModal();
      }
    });

    // 初始化
    initNow();
    rebuildAll();
  </script>
  </div>
</body>
</html>
